import{g as e,f as t}from"./p-2fd75363.js";import"./p-bb067c01.js";const s=e=>!("isConnected"in e)||e.isConnected,o=(()=>{let e;return(...t)=>{e&&clearTimeout(e),e=setTimeout((()=>{e=0,(e=>{for(let t of e.keys())e.set(t,e.get(t).filter(s))})(...t)}),2e3)}})(),n=(s,n)=>{const r=((e,t=((e,t)=>e!==t))=>{let s=new Map(Object.entries(null!=e?e:{}));const o={dispose:[],get:[],set:[],reset:[]},n=()=>{s=new Map(Object.entries(null!=e?e:{})),o.reset.forEach((e=>e()))},r=e=>(o.get.forEach((t=>t(e))),s.get(e)),i=(e,n)=>{const r=s.get(e);t(n,r,e)&&(s.set(e,n),o.set.forEach((t=>t(e,n,r))))},c="undefined"==typeof Proxy?{}:new Proxy(e,{get:(e,t)=>r(t),ownKeys:()=>Array.from(s.keys()),getOwnPropertyDescriptor:()=>({enumerable:!0,configurable:!0}),has:(e,t)=>s.has(t),set:(e,t,s)=>(i(t,s),!0)}),a=(e,t)=>(o[e].push(t),()=>{((e,t)=>{const s=e.indexOf(t);s>=0&&(e[s]=e[e.length-1],e.length--)})(o[e],t)});return{state:c,get:r,set:i,on:a,onChange:(t,s)=>{const o=a("set",((e,o)=>{e===t&&s(o)})),n=a("reset",(()=>s(e[t])));return()=>{o(),n()}},use:(...e)=>e.forEach((e=>{e.set&&a("set",e.set),e.get&&a("get",e.get),e.reset&&a("reset",e.reset)})),dispose:()=>{o.dispose.forEach((e=>e())),n()},reset:n,forceUpdate:e=>{const t=s.get(e);o.set.forEach((s=>s(e,t,t)))}}})(s,n);return(({on:s})=>{const n=new Map;"function"==typeof e&&(s("dispose",(()=>{n.clear()})),s("get",(t=>{const s=e();s&&((e,t,s)=>{const o=e.get(t);o?o.includes(s)||o.push(s):e.set(t,[s])})(n,t,s)})),s("set",(e=>{const s=n.get(e);s&&n.set(e,s.filter(t)),o(n)})),s("reset",(()=>{n.forEach((e=>e.forEach(t))),o(n)})))})(r),r};function r(e){return Object.keys(e).map((t=>encodeURIComponent(t)+"="+encodeURIComponent(e[t]))).join("&")}const i=async({fn:e,validate:t,interval:s,maxAttempts:o})=>{let n=0;const r=async(i,c)=>{const a=await e();return n++,t(a)?i(a):o&&n===o?c(new Error("Exceeded max attempts.")):void setTimeout(r,s,i,c)};return new Promise(r)},c=e=>{let t={};return Object.keys(e).forEach((s=>{""!==e[s]&&(t[s]=e[s])})),t};class a{constructor(e,t){this.urlParams=new URLSearchParams,this.isAuthorized=!1,this.redirectURI=e,this.clientID=t,this.oauthUrl=h.state.authApiHostUrl,this.authURI=new URL(`https://${this.oauthUrl}/oauth/authorize/`),this.accessTokenURL=`https://${this.oauthUrl}/oauth/access_token/`}generateCodeVerifier(){if(""!==h.state.codeVerifier)this.codeVerifier=h.state.codeVerifier;else{const e=new Uint8Array(128),t=crypto.getRandomValues(e),s=btoa(t.toString()).substr(0,128);this.codeVerifier=s,h.state.codeVerifier=this.codeVerifier}}async generateCodeChallenge(e){const t=(new TextEncoder).encode(e),s=await crypto.subtle.digest("SHA-256",t),o=btoa(String.fromCharCode.apply(null,new Uint8Array(s)));this.codeChallenge=o.replace(/\+/g,"-").replace(/\//g,"_").replace(/=/g,"")}buildAuthURI(){this.urlParams.append("response_type","code"),this.urlParams.append("client_id",this.clientID),this.urlParams.append("redirect_uri",this.redirectURI),this.urlParams.append("code_challenge",this.codeChallenge),this.urlParams.append("code_challenge_method","S256"),this.authURI.search=this.urlParams.toString(),h.state.authUri=this.authURI.toString()}getAccessToken(){return fetch(this.accessTokenURL,{credentials:"include",headers:{Authorization:"Basic "+btoa(this.clientID+":"),"Content-Type":"application/x-www-form-urlencoded"},method:"POST",body:r({grant_type:"authorization_code",scope:"printing",code:h.state.code,redirect_uri:this.redirectURI})}).then((e=>e.json())).then((e=>{e.access_token&&(h.state.isAuthorized=!0,this.isAuthorized=h.state.isAuthorized,localStorage.setItem("isAuthorized",this.isAuthorized.toString()),this.accessToken=e.access_token,localStorage.setItem("access_token",this.accessToken),h.state.accessToken=this.accessToken,this.refreshToken=e.refresh_token,localStorage.setItem("refreshToken",this.refreshToken),h.state.refreshToken=this.refreshToken)}))}refreshTokens(){fetch(this.accessTokenURL,{credentials:"include",headers:{Authorization:"Basic "+btoa(this.clientID+":"),"Content-Type":"application/x-www-form-urlencoded"},method:"POST",body:r({grant_type:"refresh_token",scope:"printing",refresh_token:h.state.refreshToken})}).then((e=>e.json())).then((e=>{e.access_token&&(this.accessToken=e.access_token,localStorage.setItem("access_token",this.accessToken),h.state.accessToken=this.accessToken,this.refreshToken=e.refresh_token,localStorage.setItem("refreshToken",this.refreshToken),h.state.refreshToken=this.refreshToken,h.state.isAuthorized=!0)}))}revokeRefreshToken(){h.state.refreshToken&&fetch(`https://${this.oauthUrl}/oauth/revoke/`,{credentials:"include",headers:{Authorization:"Basic "+btoa(this.clientID+":"),"Content-Type":"application/x-www-form-urlencoded"},method:"POST",body:r({token:h.state.refreshToken})}).catch((e=>{console.log(e)}))}}const h=n({code:"",codeVerifier:"",accessToken:"",refreshToken:"",isAuthorized:!1,devApi:!1,authApiHostUrl:"",redirectUri:"",authUri:""});export{a as E,h as a,n as c,i as p,c as r}